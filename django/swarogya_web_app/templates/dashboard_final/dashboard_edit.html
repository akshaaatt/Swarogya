{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  	<title>Swarogya</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=yes' name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css' %}"/>
  <!-- CSS Files -->
  <link rel="stylesheet" href="{% static 'dashboard_final_assets/css/material-dashboard.css' %}"  />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="{% static 'dashboard_final_assets/demo/demo.css' %}" rel="stylesheet" />

  <link rel="stylesheet" href="{% static 'barcode2/style.css' %}" />
  <link rel="stylesheet" href="{% static 'build/css/intlTelInput.css' %}">
  <link rel="stylesheet" href="{% static 'build/css/demo.css' %}">
</head>

<body onload="myOpenFunction()">
  <div class="wrapper">
    <div class="sidebar" data-color="purple" data-background-color="white" data-image="{% static 'dashboard_final_assets/img/sidebar-1.jpg'%}">
      <!--
        Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"
        Tip 2: you can also add an image using data-image tag
    -->
    <div class="row">
    <div class="logo-container">
       <div class="logo">
         <div class="col-sm-5 offset-10">
        <img src="{% static 'img/swarogya_logo_favicon_new.png' %}"> <h4><strong>Swarogya</strong></h4>
      </div>
   </div>
 </div>
 </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item " id="home_nav" name="home_nav">
            <a class="nav-link" href="{% url 'swarogya_web:dashboard_home'%}">
              <i class="material-icons">home</i>
              <p>Home</p>
            </a>
          </li>
          <li class="nav-item " id="add_patient_nav" name="add_patient_nav">
            <a class="nav-link" href="{% url 'swarogya_web:add_patient'%}">
              <i class="material-icons">add_circle</i>
              <p>Add Patient</p>
            </a>
          </li>
          <li class="nav-item " id="patient_analysis_nav" name="patient_analysis_nav">
            <a class="nav-link" href="{% url 'swarogya_web:patient_analysis'%}">
              <i class="material-icons">person_search</i>
              <p>Patient Analysis</p>
            </a>
          </li>
          <li class="nav-item " id="report_analysis_nav" name="report_analysis_nav">
            <a class="nav-link" href="{% url 'swarogya_web:report_analysis'%}">
              <i class="material-icons">local_hospital</i>
              <p>Report Analysis</p>
            </a>
          </li>
          <li class="nav-item " id="hospital_analysis_nav" name="hospital_analysis_nav">
            <a class="nav-link" href="{% url 'swarogya_web:hospital_analysis'%}">
              <i class="material-icons">local_hospital</i>
              <p>Hospital Analysis</p>
            </a>
          </li>
          <li class="nav-item " id="wing_analysis_nav" name="wing_analysis_nav">
            <a class="nav-link" href="{% url 'swarogya_web:wing_analysis'%}">
              <i class="material-icons">domain</i>
              <p>Wing Analysis</p>
            </a>
          </li>
          <li class="nav-item " id="floor_analysis_nav" name="floor_analysis_nav">
            <a class="nav-link" href="{% url 'swarogya_web:floor_analysis'%}">
              <i class="material-icons">apartment</i>
              <p>Floor Analysis</p>
            </a>
          </li>

          <li class="nav-item " id="room_analysis_nav" name="room_analysis_nav">
            <a class="nav-link" href="{% url 'swarogya_web:room_analysis'%}">
              <i class="material-icons">room</i>
              <p>Room Analysis</p>
            </a>
          </li>
          <li class="nav-item " id="home_quarantine_nav" name="home_quarantine_nav">
            <a class="nav-link" href="{% url 'swarogya_web:home_quarantine'%}">
              <i class="material-icons">house</i>
              <p>Home Care Analysis</p>
            </a>
          </li>

          <li class="nav-item " id="notification_nav" name="notification_nav">
            <a class="nav-link" href="{% url 'swarogya_web:notifications'%}">
              <i class="material-icons">notification_important</i>
              <p>Notifications</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Dashboard</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <form class="navbar-form">
            </form>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" onclick="notify_page()" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons" >notifications</i>
                  <span class="notification" id="notification_number" name="notification_number"></span>
                  <p class="d-lg-none d-md-block">
                      Notifications
                    </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                        <div id="my_notifications" name="my_notifications"></div>
                </div>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">person</i>
                  <p class="d-lg-none d-md-block">
                    Account
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                  <a class="dropdown-item" href="javascript:logout();">Log out</a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="container-fluid">

          {% block content %}

          {% endblock %}

        </div>
      </div>
      <footer class="footer">
        <div class="container-fluid">
          <nav class="float-left">
            <ul>
              <li>
                <a href="">

                </a>
              </li>
              <li>
              </li>
              <li>
              </li>
            </ul>
          </nav>
        </div>
      </footer>

    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="{% static 'js/swarogya_dash_jquery.js' %}"></script>
<script type="text/javascript" src="{% static 'barcode2/jquery.js' %}"></script>

  <!--   Core JS Files   -->
  <script type="text/javascript" src="{% static 'barcode2/barcode.js' %}"></script>
  <script src="{% static 'dashboard_final_assets/js/core/jquery.min.js' %}"></script>
  <script src="{% static 'dashboard_final_assets/js/plugins/jquery.validate.min.js' %}"></script>
  <!-- Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
  <script src="{% static 'dashboard_final_assets/js/plugins/jquery.bootstrap-wizard.js' %}"></script>
  <script src="{% static 'dashboard_final_assets/js/core/popper.min.js' %}"></script>
  <script src="{% static 'dashboard_final_assets/js/core/bootstrap-material-design.min.js' %}"></script>
  <script src="{% static 'dashboard_final_assets/js/plugins/perfect-scrollbar.jquery.min.js' %}"></script>
  <!-- Plugin for the momentJs  -->
  <script src="{% static 'dashboard_final_assets/js/plugins/moment.min.js' %}"></script>
  <!--  Plugin for Sweet Alert -->
  <script src="{% static 'dashboard_final_assets/js/plugins/sweetalert2.js' %}"></script>
  <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
  <script src="{% static 'dashboard_final_assets/js/plugins/bootstrap-selectpicker.js' %}"></script>
  <!--  Plugin for the DateTimePicker, full documentation here: https://eonasdan.github.io/bootstrap-datetimepicker/ -->
  <script src="{% static 'dashboard_final_assets/js/plugins/bootstrap-datetimepicker.min.js' %}"></script>
  <!--  DataTables.net Plugin, full documentation here: https://datatables.net/  -->
  <script src="{% static 'dashboard_final_assets/js/plugins/jquery.dataTables.min.js' %}"></script>
  <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
  <script src="{% static 'dashboard_final_assets/js/plugins/bootstrap-tagsinput.js' %}"></script>
  <!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
  <script src="{% static 'dashboard_final_assets/js/plugins/jasny-bootstrap.min.js' %}"></script>
  <!--  Full Calendar Plugin, full documentation here: https://github.com/fullcalendar/fullcalendar    -->
  <script src="{% static 'dashboard_final_assets/js/plugins/fullcalendar.min.js' %}"></script>
  <!-- Vector Map plugin, full documentation here: http://jvectormap.com/documentation/ -->
  <script src="{% static 'dashboard_final_assets/js/plugins/jquery-jvectormap.js' %}"></script>
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <script src="{% static 'dashboard_final_assets/js/plugins/nouislider.min.js' %}"></script>
  <!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support SweetAlert -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js' %}"></script>
  <!-- Library for adding dinamically elements -->
  <script src="{% static 'dashboard_final_assets/js/plugins/arrive.min.js' %}"></script>
  <!--  Google Maps Plugin    -->
  <!-- Chartist JS -->
  <script src="{% static 'dashboard_final_assets/js/plugins/chartist.min.js' %}"></script>
  <!--  Notifications Plugin    -->
  <script src="{% static 'dashboard_final_assets/js/plugins/bootstrap-notify.js' %}"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{% static 'dashboard_final_assets/js/material-dashboard.js' %}" type="text/javascript"></script>
  <!-- Material Dashboard DEMO methods, don't include it in your project! -->
  <script src="{% static 'dashboard_final_assets/demo/demo.js' %}"></script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-messaging.js"></script>
<script src="{% static 'js/require.js'%}"> </script>
<script src="{% static 'build/js/intlTelInput.js' %}"></script>


<script>
  var input = document.querySelector("#phone_no");
  var first_emergency_contact_number = document.querySelector("#first_emergency_contact_number");
  var second_emergency_contact_number = document.querySelector("#second_emergency_contact_number");
  window.intlTelInput(input, {
    autoHideDialCode: false,
     initialCountry: "in",
    nationalMode: false,
    utilsScript: "{% static 'build/js/utils.js' %}",
  });
  window.intlTelInput(first_emergency_contact_number, {
    autoHideDialCode: false,
     initialCountry: "in",
    nationalMode: false,
    utilsScript: "{% static 'build/js/utils.js' %}",
  });
  window.intlTelInput(second_emergency_contact_number, {
    autoHideDialCode: false,
     initialCountry: "in",
    nationalMode: false,
    utilsScript: "{% static 'build/js/utils.js' %}",
  });

</script>
<script>

  var firebaseConfig = {
    apiKey: "AIzaSyCQ3q94q3HSYsrc8TvvQcgysw5Y7YFRMqg",
    authDomain: "swarogya-aa30d.firebaseapp.com",
    databaseURL: "https://swarogya-aa30d.firebaseio.com",
    projectId: "swarogya-aa30d",
    storageBucket: "swarogya-aa30d.appspot.com",
    messagingSenderId: "819552361415",
    appId: "1:819552361415:web:5c22d654f938c1403697e2",
    measurementId: "G-3MEWE6QZGV"
  };
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();

    firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      // User is signed in.
      var user = firebase.auth().currentUser;

      if(user != null){
      }

    } else {
        window.location.assign("{% url 'swarogya_web:staff_login'%}");
    }
  });
          function logout(){
            if(window.localStorage.getItem('duty') == 'hospitalDuty'){

              var cityRef = db.collection('Employees').doc(window.localStorage.getItem('doc_id'));

              var removeCapital = cityRef.update({
              token :  firebase.firestore.FieldValue.delete(),
                  wingNumber: firebase.firestore.FieldValue.delete(),
                  floorNumber : firebase.firestore.FieldValue.delete(),
                  duty : firebase.firestore.FieldValue.delete(),
              })
              .then(function() {
                  console.log("Document successfully updated!");
                  alert('Hola');
              })
              .catch(function(error) {
                  // The document probably doesn't exist.
                  console.error("Error updating document: ", error);
                  alert('Hola');
              });
            }
            else {
              var cityRef = db.collection('Employees').doc(window.localStorage.getItem('doc_id'));

              var removeCapital = cityRef.update({
                token : firebase.firestore.FieldValue.delete(),
                  duty : firebase.firestore.FieldValue.delete(),
              })
              .then(function() {
                  console.log("Document successfully updated!");
                  alert('Hola');
              })
              .catch(function(error) {
                  // The document probably doesn't exist.
                  console.error("Error updating document: ", error);
                  alert('Hola');
              });
            }
        firebase.auth().signOut();
        }

        const messaging = firebase.messaging();
        messaging.usePublicVapidKey("BGFagI-CPw5NdKArp8jJ-EccGWu8c8FAxea5C9YQw1M-3MpkbtZW2M0BMz3hMwr_PL8UbVQUiY7umy1eQza1H30");

        messaging.onTokenRefresh(function() {
            messaging.getToken().then(function(refreshedToken) {
                console.log('Token refreshed.');
                // Send Instance ID token to app server.
                sendTokenToServer(refreshedToken);
            }).catch(function(err) {
                console.log('Unable to retrieve refreshed token ', err);
            });
        });

        function appendMessage(payload){
          window.localStorage.setItem('count', Number(window.localStorage.getItem('count'))+1);
          document.getElementById('notification_number').innerText =localStorage.count;
          if (window.localStorage.getItem('notifications')){
             var ret = JSON.parse(window.localStorage.getItem('notifications'));
          }else {
            var ret = new Array();
          }
          var d = new Date();
          if(payload['data']['title'].includes("parameters")){
            md.showMeasurementsNotification('top','right',d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
            ret.push(d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
          }
          else if(payload['data']['title'].includes("Assistance")){
            md.showAssistanceNotification('top','right',d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
            ret.push(d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
          }
          else if(payload['data']['title'].includes("Emergency")){
              md.showEmergencyNotification('top','right',d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
              ret.push(d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
          }
          else {
              md.showRegistrationNotification('top','right',d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
              ret.push(d+"<br>"+ payload['data']['title'] +"<br>"+ payload['data']['body']);
          }
          window.localStorage.setItem('notifications',JSON.stringify(ret));
        }

        messaging.onMessage((payload) => {
            console.log('Message received. ', payload);
            appendMessage(payload);
          });

        function initToken() {
            messaging.getToken().then(function(currentToken) {
                if (currentToken) {
                  //alert(currentToken);
                  console.log(currentToken);
                    sendTokenToServer(currentToken);
                } else {
                    console.log('No Instance ID token available. Request permission to generate one.');
                }
            }).catch(function(err) {
                console.log('An error occurred while retrieving token. ', err);

            });
        }

        function sendTokenToServer(currentToken) {
            if (!isTokenSentToServer()) {
              console.log('Sending token to server...');
              // TODO(developer): Send the current token to your server.
              setTokenSentToServer(true);
            } else {
              console.log('Token already sent to server so won\'t send it again ' +
                  'unless it changes');
            }

          }


        function isTokenSentToServer() {
        return window.localStorage.getItem('sentToServer') === '1';
        }

        function setTokenSentToServer(sent) {
        window.localStorage.setItem('sentToServer', sent ? '1' : '0');
        }


        function sendTokenToServer(currentToken) {

          db.collection("Employees").where("emailId", "==",window.localStorage.getItem('user_email'))
              .get()
              .then(function(querySnapshot) {
                  querySnapshot.forEach(function(doc) {
                      // doc.data() is never undefined for query doc snapshots
                       var data = doc.data();
                      window.localStorage.setItem('doc_id', doc.id);
                      window.localStorage.setItem('hospitalName',data['hospitalName']) ;
                  });
              })
              .catch(function(error) {
                  alert("Error getting documents: ", error);
              });
              var washingtonRef = db.collection("Employees").doc(window.localStorage.getItem('doc_id'));
              // Set the "capital" field of the city 'DC'
              if(window.localStorage.getItem('duty')=='hospitalDuty'){
                return washingtonRef.update({
                    token : currentToken,
                    wingNumber : window.localStorage.getItem('userWing'),
                    floorNumber : window.localStorage.getItem('userFloor'),
                    duty : window.localStorage.getItem('duty'),
                })
                .then(function() {
                    console.log("Document successfully updated!");
                })
                .catch(function(error) {
                    // The document probably doesn't exist.
                    console.error("Error updating document: ", error);
                });
              }
              else {
                return washingtonRef.update({
                    token : currentToken,
                    duty : window.localStorage.getItem('duty'),
                })
                .then(function() {
                    console.log("Document successfully updated!");
                })
                .catch(function(error) {
                    // The document probably doesn't exist.
                    console.error("Error updating document: ", error);
                });
              }
        }


        function requestPermission() {
        console.log('Requesting permission...');
        // [START request_permission]
        Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          console.log('Notification permission granted.');
        initToken();
        } else {
          console.log('Unable to get permission to notify.');
        }
        });
        }
        requestPermission();
  </script>

    <script>
    $(document).bind("contextmenu",function(e) {
       e.preventDefault();
      });
      $(document).keydown(function(e){
          if(e.which === 123){
             return false;
          }
      });
      document.getElementById('notification_number').innerText =  Number(window.localStorage.getItem('count'));
    function notify_page(){
        window.location.assign("{% url 'swarogya_web:notifications'%}");
    }
    </script>


</body>

</html>
